<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="com.pro.myrp.persistence.stock.StockDAO">
 
 	<!-- 재고현황 -->
	<select id = "select_stock_condition" resultType="Stock_conditionDTO">
 		SELECT *
 		FROM stock_information s join product p 
 		ON s.product_id = p.product_id
 	</select>
 	
 	<!-- 재고수불부 검색페이지 -->
 	<select id = "select_search_stockpile_search" parameterType="java.util.Map" resultType="stockpile_searchDTO">
		SELECT	* 
		FROM	${where}
		WHERE 	${condition} like '%'||#{search}||'%'
 	</select>
 	
 	<!-- 재고수불부 결과 페이지 - 재고조정-->
 	<select id = "select_stockpile_search" parameterType="java.util.Map" resultType="select_stockpile_searchDTO">
 		SELECT *
 		FROM	(SELECT *
		 		 FROM	(SELECT * 
		 		 		 FROM	stock_order st JOIN adjustment_inventory ad
		 		 		 ON		st.stock_order_id = ad.stock_order_id
		 		 		 JOIN	stock_information stock
		 		 		 ON		stock.product_id = st.product_id
		 		 		
		 		 		 <if test = "warehouse != null">
					 		 WHERE st.warehouse_id in
						 		 <foreach item="warehouse" collection="warehouse" open="(" separator="," close=")">
						 		 	#{warehouse}
						 		 </foreach>
			 			 </if>
			 			 <if test = "product != null and warehouse != null">
			 			 AND
			 			 </if>
			 			 <if test = "product != null and warehouse == null">
			 			 WHERE
			 			 </if>
			 			 <if test = "product != null">
					 		 stock.product_id in
					 		 <foreach item="product" collection="product" open="(" separator="," close=")">
					 		 	#{product}
					 		 </foreach>
				 		 </if>
						)
			 	<!-- ORDER BY stock.product_id -->
				)
		WHERE	update_date BETWEEN #{start_day} AND #{end_day}
 	</select>
 	
 	<!-- 재고수불부 결과 페이지 - 구매-->
 	<select id = "select_stockpile_search_purchase" parameterType="java.util.Map" resultType="select_stockpile_searchDTO">
 		SELECT *
 		FROM	(SELECT *
		 		 FROM	(SELECT * 
		 		 		 FROM	purchase_order p  JOIN	stock_information stock
		 		 		 ON		stock.product_id = p.product_id
			 			 <if test = "product != null">
					 	 WHERE	product_id in
					 		 <foreach item="product" collection="product" open="(" separator="," close=")">
					 		 	#{product}
					 		 </foreach>
				 		 </if>
						 )
				ORDER BY update_date DESC
				)		
		<if test = "startday != null">
			update_date BETWEEN #{start_day} AND #{end_day}
		</if>
 	</select>
 	
 		<!-- 재고수불부 결과 페이지 - 판매-->
 	<select id = "select_stockpile_search_sales" parameterType="java.util.Map" resultType="select_stockpile_searchDTO">
 		SELECT *
 		FROM	(SELECT *
		 		 FROM	(SELECT * 
		 		 		 FROM	sales_order s JOIN	stock_information stock
		 		 		 ON		stock.product_id = s.product_id
		 		 		 WHERE	sales_state = #{sales_state}
			 			 <if test = "product != null">
					 	 OR	product_id in
					 		 <foreach item="product" collection="product" open="(" separator="," close=")">
					 		 	#{product}
					 		 </foreach>
				 		 </if>
						 )
				ORDER BY update_date DESC
				)		
		<if test = "startday != null">
			update_date BETWEEN #{start_day} AND #{end_day}
		</if>
 	</select>
 	
 	
 	<!-- product id로 name stock amount 가져오기 -->
 	<select id = "select_product_name" parameterType="java.util.Map" resultType="ProductVO">
 		SELECT	p.product_name as product_name, p.product_id as product_id, s.stock_amount as stock_amount
 		FROM	product p JOIN stock_information s
 		ON		s.product_id = p.product_id
 		<if test = "product_id != null">
 			WHERE	p.product_id = #{product_id}
 		</if>
 	</select>
</mapper>
